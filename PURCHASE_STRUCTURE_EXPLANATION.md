# Purchase Structure Explanation

## Overview

This document explains why different purchases in Firestore have different structures and why documents aren't being generated.

## Issue 1: Different Purchase Structures

### Old Structure (e.g., `P1llnJ5znwd2PS2qLZnZ`)

**Created:** Before webhook system was implemented  
**Document ID:** Uses `client_reference_id` from Stripe (the order ID)  
**Fields:**
- Basic fields: `id`, `userId`, `customerEmail`, `items`, `total`, `currency`, `status`
- **Missing:** `documentsGenerated`, `documentsFailed`, `packageFiles`, `stripeSessionId`, `source`

**Why different:**
- These were created manually or via a different flow
- They don't have the webhook processing metadata
- They may have been created before document generation was implemented

### New Structure (e.g., `12f2a4e8-07b7-4b3a-b351-d9034b32baaa`)

**Created:** By Stripe webhook after payment  
**Document ID:** UUID generated by webhook (`uuidv4()`)  
**Fields:**
- All basic fields
- **New fields:**
  - `stripeSessionId`: Stripe checkout session ID
  - `stripePaymentIntentId`: Stripe payment intent ID
  - `source: 'stripe_webhook'`: Identifies webhook-created purchases
  - `documentsGenerated`: Number of documents successfully generated
  - `documentsFailed`: Number of documents that failed to generate
  - `webhookProcessedAt`: Timestamp when webhook processed
  - `items[].packageFiles`: Generated document files (PDF/Word)
  - `items[].documentId`: ID of generated document package
  - `items[].storagePath`: Firebase Storage path
  - `items[].downloadUrl`: Download URL for documents

**Why different:**
- Created automatically by webhook after successful payment
- Includes all metadata needed for document generation tracking
- Has structure to store generated documents

## Issue 2: Document Generation Failure

### Root Cause: Font Error

**Error:** `Error: Unknown font format`  
**Location:** PDFKit/fontkit library when trying to load `.otf` fonts  
**Impact:** All document generation fails, leaving purchases with `documentsGenerated: 0` and `documentsFailed: 1`

### Why It Happens

1. PDFKit uses `fontkit` library to parse font files
2. `fontkit` may not properly support `.otf` (OpenType Font) format in all environments
3. The fonts exist in `functions/assets/fonts/` but can't be parsed at runtime
4. This causes the entire PDF generation to fail

### Solution Implemented

**Font Fallback System:**
- Try to load custom fonts (`.otf` files)
- If loading fails, automatically fall back to built-in PDFKit fonts (Helvetica)
- This ensures documents can always be generated, even if custom fonts fail

**Changes:**
1. `ensureFontAvailability()` now returns `boolean` instead of throwing
2. Font registration wrapped in try-catch
3. `getFont()` helper function returns appropriate font name
4. All font references use `getFont()` instead of hardcoded strings

## Current Status

### Fixed Issues ✅

1. ✅ Webhook signature verification (200 OK)
2. ✅ OPENAI_API_KEY configuration
3. ✅ Firestore timestamp error (can't use `FieldValue.serverTimestamp()` in arrays)
4. ✅ Font error (fallback to built-in fonts)

### Remaining Issues

1. ⚠️ Old purchases (`P1llnJ5znwd2PS2qLZnZ`) don't have document generation
   - **Solution:** Can create a migration script to reprocess them

2. ⚠️ Failed purchases need reprocessing
   - **Solution:** Can create a script to regenerate documents for failed purchases

## Where Documents Are Stored

### Firestore Structure

```
purchases/{purchaseId}
  ├── items[0]
  │   ├── packageFiles
  │   │   ├── templatePdf: { path, downloadUrl }
  │   │   ├── templateDocx: { path, downloadUrl }
  │   │   ├── samplePdf: { path, downloadUrl }
  │   │   ├── sampleDocx: { path, downloadUrl }
  │   │   └── studyMaterialPdf: { path, downloadUrl }
  │   ├── documentId: "package-id"
  │   ├── storagePath: "students/{userId}/documents/{packageId}/..."
  │   └── downloadUrl: "https://..."
  ├── documentsGenerated: 1
  └── documentsFailed: 0
```

### Firebase Storage Structure

```
students/{userId}/documents/{packageId}/
  ├── template.pdf
  ├── template.docx
  ├── sample.pdf
  ├── sample.docx
  └── study-material.pdf
```

## Testing

After deploying the font fix:

1. **Make a new purchase** - Should generate documents successfully
2. **Check Firestore** - Purchase should have `documentsGenerated: 1` and `packageFiles`
3. **Check Storage** - Files should be in `students/{userId}/documents/{packageId}/`
4. **Check Dashboard** - Documents should appear in "Historial de compras"

## Next Steps

1. ✅ Deploy font fix
2. ⏳ Test with new purchase
3. ⏳ Create reprocessing script for failed purchases
4. ⏳ Create migration script for old purchases (if needed)

